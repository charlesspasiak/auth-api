name: Continuous Deployment

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: SSH and deploy app
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USERNAME }}
                  key: ${{ secrets.SSH_KEY }}
                  port: ${{ secrets.SSH_PORT }}
                  script: |
                      cd ~/auth-api
                      git pull origin master
                      # Install Node.js and npm
                      sudo apt-get update
                      sudo apt-get install -y nodejs npm

                      # Install project dependencies
                      npm install

                      # Run database migrations
                      npm run migrate up

                      # Restart the application using pm2
                      npm install -g pm2
                      pm2 restart auth-api
